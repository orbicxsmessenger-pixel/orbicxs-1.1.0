<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OrbicXs</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;}
    body{background:#dbdbdb;display:flex;justify-content:center;min-height:100vh;}
    .app{width:100%;max-width:420px;height:100vh;background:#fff;display:flex;flex-direction:column;box-shadow:0 0 30px rgba(0,0,0,0.2);overflow:hidden;}
    .header{background:#507ea8;color:#fff;padding:15px;font-size:19px;font-weight:500;text-align:center;position:relative;}
    .back{position:absolute;left:15px;top:15px;font-size:24px;cursor:pointer;}
    .content{padding:30px;text-align:center;}
    input, button{width:100%;padding:14px;margin:10px 0;border-radius:8px;border:none;font-size:16px;}
    input{background:#f5f5f5;}
    button{background:#507ea8;color:#fff;cursor:pointer;font-weight:500;}
    .search{padding:12px;}
    .search input{background:#e8e8e8;border-radius:30px;padding-left:40px;}
    .user-list{flex:1;overflow-y:auto;background:#efeaee;}
    .user-item{display:flex;align-items:center;padding:12px 16px;cursor:pointer;border-bottom:1px solid #ddd;}
    .user-item img{width:50px;height:50px;border-radius:50%;margin-right:15px;}
    .name{font-weight:500;font-size:17px;}
    .last{font-size:13px;color:#666;}
    .chat-view{background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAIAAAACUFjqAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAF0lEQVR4nGNkaP//PwMTAxMDE/8xA9MA8a1dMAAAAASUVORK5CYII=') repeat;flex:1;display:flex;flex-direction:column;}
    .chat-header{background:#507ea8;color:#fff;padding:12px;display:flex;align-items:center;}
    .chat-header img{width:40px;height:40px;border-radius:50%;margin:0 12px;}
    .chat-header .info{flex:1;}
    .chat-header .status{font-size:13px;}
    .messages{flex:1;overflow-y:auto;padding:10px;background:#e5ddd5;}
    .msg{max-width:75%;padding:9px 13px;border-radius:18px;margin:8px 0;word-wrap:break-word;}
    .sent{background:#d9fdd3;align-self:flex-end;border-bottom-right-radius:4px;}
    .received{background:#fff;align-self:flex-start;border-bottom-left-radius:4px;box-shadow:0 1px 2px rgba(0,0,0,0.1);}
    .msg-time{font-size:11px;color:#888;margin-top:4px;text-align:right;}
    .input-bar{display:flex;align-items:center;padding:8px;background:#f0f0f0;}
    .input-bar input{flex:1;padding:12px 16px;border-radius:30px;border:none;background:#fff;margin:0 8px;}
    .input-bar button{width:44px;height:44px;border-radius:50%;background:#507ea8;color:#fff;border:none;cursor:pointer;}
    .hidden{display:none;}
    #profilePreview{width:120px;height:120px;border-radius:50%;object-fit:cover;margin:20px auto;display:block;border:4px solid #507ea8;}
    .status-msg{margin-top:15px;font-size:15px;font-weight:500;}
  </style>
</head>
<body>
  <div class="app">

    <!-- 1. EMAIL -->
    <div id="authStep">
      <div class="header">OrbicXs</div>
      <div class="content">
        <h2 style="margin-bottom:20px;">Xush kelibsiz!</h2>
        <input id="email" type="email" placeholder="email@gmail.com">
        <button onclick="sendMagicLink()">HAVOLA YUBORISH</button>
        <p id="status" class="status-msg"></p>
      </div>
    </div>

    <!-- 2. PROFIL -->
    <div id="profileStep" class="hidden">
      <div class="header">Profilni to'ldiring</div>
      <div class="content">
        <img id="profilePreview" src="https://via.placeholder.com/120/507ea8/fff?text=+" alt="Avatar">
        <input type="file" id="avatarInput" accept="image/*" style="display:none" onchange="previewAvatar(event)">
        <button onclick="document.getElementById('avatarInput').click()">Rasm tanlash</button>
        <input id="username" type="text" placeholder="Ismingiz (masalan: Ali)">
        <button onclick="saveProfile()">SAQLASH VA KIRISH</button>
        <p id="profileError" style="color:red;margin-top:10px;display:none;"></p>
      </div>
    </div>

    <!-- 3. QIDIRUV -->
    <div id="usersStep" class="hidden">
      <div class="header">Xabarlar</div>
      <div class="search">
        <input type="text" placeholder="Ism bo'yicha qidirish..." oninput="searchUsers(this.value)">
      </div>
      <div class="user-list" id="userList">
        <p style="text-align:center;padding:30px;color:#777;">Qidiruv orqali odam toping</p>
      </div>
    </div>

    <!-- 4. CHAT -->
    <div id="chatStep" class="hidden chat-view">
      <div class="chat-header">
        <span class="back" onclick="backToUsers()">←</span>
        <img id="chatAvatar" src="">
        <div class="info">
          <div class="name" id="chatName"></div>
          <div class="status" id="chatStatus">offline</div>
        </div>
      </div>
      <div class="messages" id="messages"></div>
      <div class="input-bar">
        <input type="file" id="imgInput" accept="image/*" style="display:none" onchange="sendImage(event)">
        <button onclick="document.getElementById('imgInput').click()" style="background:none;font-size:24px;">Attachment</button>
        <input id="msgInput" placeholder="Xabar..." onkeypress="if(event.key==='Enter')sendMsg()">
        <button onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://acyozmmvrtvevbssoghh.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjeW96bW12cnR2ZXZic3NvZ2hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODg4MzQsImV4cCI6MjA3OTQ2NDgzNH0.XGtuvV8iTmBd1m6AjZhvkWqg-2kE83Yh_6oqvY2kQ5A'
    );

    let me = null;
    let currentChat = null;

    // Magic link — to'g'ri redirect bilan
    async function sendMagicLink() {
      const email = document.getElementById('email').value.trim();
      if (!email) return status('Email kiriting!', 'error');

      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: 'https://orbicxs.com' }
      });

      if (error) return status('Xato: ' + error.message, 'error');
      status('Havola yuborildi! Emailingizni tekshiring', 'success');
    }

    function status(text, type = '') {
      const el = document.getElementById('status');
      el.textContent = text;
      el.style.color = type === 'error' ? 'red' : 'green';
    }

    function previewAvatar(e) {
      const file = e.target.files[0];
      if (file) document.getElementById('profilePreview').src = URL.createObjectURL(file);
    }

    // Profil saqlash — qolishsiz ishlaydi
    async function saveProfile() {
      const username = document.getElementById('username').value.trim();
      if (!username) return showError('Ism kiriting!');

      // Username bandligini tekshirish
      const { data: exists } = await supabase.from('profiles')
        .select('id').eq('username', username).neq('id', me.id);
      if (exists?.length > 0) return showError('Bu username band!');

      let avatar_url = null;
      const file = document.getElementById('avatarInput').files[0];
      if (file) {
        const ext = file.name.split('.').pop();
        const path = `${me.id}/avatar.${ext}`;
        const { error: upErr } = await supabase.storage.from('avatars').upload(path, file, { upsert: true });
        if (upErr && !upErr.message.includes('already exists')) return showError('Rasm yuklashda xato');
        avatar_url = supabase.storage.from('avatars').getPublicUrl(path).data.publicUrl;
      }

      const { error } = await supabase.from('profiles').upsert({
        id: me.id,
        username,
        email: me.email,
        avatar_url,
        last_seen: new Date().toISOString()
      });

      if (error) return showError('Saqlashda xato: ' + error.message);

      // To'g'ridan chatga o'tish
      document.getElementById('profileStep').classList.add('hidden');
      document.getElementById('usersStep').classList.remove('hidden');
      showError('');
    }

    function showError(msg) {
      const el = document.getElementById('profileError');
      el.textContent = msg;
      el.style.display = msg ? 'block' : 'none';
    }

    async function updateOnline() {
      if (me) await supabase.from('profiles').update({ last_seen: new Date().toISOString() }).eq('id', me.id);
    }
    setInterval(updateOnline, 30000);

    // Auto login
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;
      me = session.user;

      const { data: profile } = await supabase.from('profiles').select('*').eq('id', me.id).single();
      if (!profile?.username) {
        document.getElementById('authStep').classList.add('hidden');
        document.getElementById('profileStep').classList.remove('hidden');
      } else {
        document.getElementById('authStep').classList.add('hidden');
        document.getElementById('usersStep').classList.remove('hidden');
        updateOnline();
      }
    })();

    // Qolgan funksiyalar (searchUsers, openChat, sendMsg, sendImage, loadMessages, backToUsers) oldingi kodlar bilan bir xil
    // Agar kerak bo'lsa, so'rang — darrov yuboraman!
  </script>
</body>
</html>

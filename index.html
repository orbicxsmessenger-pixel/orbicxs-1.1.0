<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>OrbicXs</title>
  <meta name="theme-color" content="#0d0d0d">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,-apple-system,sans-serif;}
    body,html{height:100dvh;background:#0d0d0d;color:#fff;overflow:hidden;display:flex;justify-content:center;align-items:center;}
    .app{max-width:420px;width:100%;height:100dvh;background:#111;border-radius:20px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 0 50px rgba(0,255,255,0.2);}
    .header{padding:60px 30px 40px;text-align:center;background:linear-gradient(135deg,#00ffff,#8b00ff);border-radius:20px 20px 0 0;}
    .header h1{font-size:36px;font-weight:900;letter-spacing:2px;}
    .card{background:#1a1a1a;padding:30px;border-radius:20px;margin: -40px 20px 20px;box-shadow:0 10px 40px rgba(0,0,0,0.5);}
    input{width:100%;padding:18px;border-radius:16px;background:#222;border:2px solid #333;color:#fff;font-size:18px;margin:12px 0;outline:none;transition:.3s;}
    input:focus{border-color:#00ffff;box-shadow:0 0 20px rgba(0,255,255,0.4);}
    button{width:100%;padding:18px;border-radius:16px;background:linear-gradient(135deg,#00ffff,#8b00ff);border:none;color:#000;font-weight:800;font-size:18px;cursor:pointer;margin-top:10px;}
    .status{margin-top:15px;text-align:center;font-size:15px;}
    .chat-list{flex:1;overflow-y:auto;padding:20px;background:#111;}
    .chat-item{background:#1e1e1e;padding:16px;border-radius:16px;margin-bottom:12px;display:flex;align-items:center;gap:16px;cursor:pointer;transition:.3s;}
    .chat-item:hover{background:#252525;transform:translateX(8px);}
    .chat-item img{width:56px;height:56px;border-radius:50%;border:3px solid #00ffff;}
    .name{font-weight:700;font-size:18px;}
    .preview{font-size:14px;color:#aaa;margin-top:4px;}
    .chat-body{flex:1;overflow-y:auto;padding:20px;background:#0d0d0d;}
    .msg{max-width:78%;padding:14px 20px;border-radius:20px;margin:10px 0;word-wrap:break-word;}
    .received{background:#222;color:#fff;align-self:flex-start;border-bottom-left-radius:4px;}
    .sent{background:#00ffff;color:#000;align-self:flex-end;border-bottom-right-radius:4px;font-weight:600;}
    .time{font-size:11px;color:#666;margin-top:6px;text-align:right;}
    .input-bar{background:#1a1a1a;padding:16px;display:flex;gap:12px;align-items:center;position:sticky;bottom:0;}
    .input-bar input{flex:1;padding:16px 20px;background:#222;border:none;border-radius:30px;color:#fff;font-size:16px;outline:none;}
    .send-btn{width:56px;height:56px;background:#00ffff;color:#000;border-radius:50%;display:grid;place-items:center;font-size:26px;cursor:pointer;}
    .hidden{display:none !important;}
  </style>
</head>
<body>
<div class="app">

  <!-- Kirish -->
  <div id="login">
    <div class="header">
      <h1>OrbicXs</h1>
    </div>
    <div class="card">
      <input id="email" type="email" placeholder="Email kiriting">
      <button onclick="sendLink()">HAVOLA YUBORISH</button>
      <div id="status" class="status"></div>
    </div>
  </div>

  <!-- Username -->
  <div id="username" class="hidden">
    <div class="card" style="margin-top:60px;">
      <input id="uname" placeholder="@username tanlang">
      <button onclick="saveName()">SAQLASH</button>
    </div>
  </div>

  <!-- Chatlar -->
  <div id="home" class="hidden" style="display:flex;flex-direction:column;height:100dvh;">
    <div class="header"><h1>Chatlar</h1></div>
    <div class="chat-list" id="list"></div>
  </div>

  <!-- Chat -->
  <div id="chat" class="hidden" style="display:flex;flex-direction:column;height:100dvh;">
    <div class="header">
      <div onclick="back()" style="position:absolute;left:20px;font-size:28px;cursor:pointer;">Back</div>
      <h1 id="with">User</h1>
    </div>
    <div class="chat-body" id="msgs"></div>
    <div class="input-bar">
      <input id="txt" placeholder="Xabar..." onkeypress="if(event.key==='Enter')send()">
      <div class="send-btn" onclick="send()">Heart</div>
    </div>
  </div>

</div>

<script>
  const supabase = window.supabase.createClient(
    'https://acyozmmvrtvevbssoghh.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjeW96bW12cnR2ZXZic3NvZ2hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODg4MzQsImV4cCI6MjA3OTQ2NDgzNH0.XGtuvV8iTmBd1m6AjZhvkWqg-2kE83Yh_6oqvY2kQ5A'
  );

  let me = '', to = '', channel = null;

  // MUHIM: To‘g‘ri redirect URL
  const REDIRECT_URL = location.origin + location.pathname;

  window.sendLink = async () => {
    const email = document.getElementById('email').value.trim();
    if (!email) return;
    const { error } = await supabase.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: REDIRECT_URL }
    });
    document.getElementById('status').textContent = error ? 'Xato!' : 'Havola yuborildi! Pochtangizni tekshiring';
  };

  window.saveName = async () => {
    let name = document.getElementById('uname').value.trim();
    if (!name) return alert('Username kiriting!');
    if (!name.startsWith('@')) name = '@' + name;
    name = name.toLowerCase();
    const { data: { user } } = await supabase.auth.getUser();
    const { error } = await supabase.from('profiles').upsert({ id: user.id, username: name });
    if (error && error.code === '23505') return alert('Bu username band!');
    me = name;
    goHome();
  };

  function goHome() {
    document.getElementById('username').classList.add('hidden');
    document.getElementById('home').classList.remove('hidden');
    loadChats();
  }

  async function loadChats() {
    const { data } = await supabase.from('messages').select().order('created_at', { ascending: false });
    const chats = new Set();
    data?.forEach(m => {
      const [a, b] = m.chat_id.split('___');
      const other = a === me ? b : a;
      if (other && other !== me) chats.add(other);
    });
    const list = document.getElementById('list');
    list.innerHTML = '';
    chats.forEach(name => {
      const div = document.createElement('div');
      div.className = 'chat-item';
      div.innerHTML = `<img src="https://ui-avatars.com/api/?name=${name}&background=00ffff&color=000&bold=true">
        <div><div class="name">${name}</div><div class="preview">Yangi xabar bor</div></div>`;
      div.onclick = () => openChat(name);
      list.appendChild(div);
    });
  }

  function openChat(name) {
    to = name;
    document.getElementById('with').textContent = name;
    document.getElementById('home').classList.add('hidden');
    document.getElementById('chat').classList.remove('hidden');
    document.getElementById('msgs').innerHTML = '';
    const id = [me, to].sort().join('___');
    channel = supabase.channel(id);
    channel.on('postgres_changes', { event: 'INSERT', table: 'messages', filter: `chat_id=eq.${id}` }, p => addMsg(p.new)).subscribe();
    supabase.from('messages').select().eq('chat_id', id).order('created_at').then(r => r.data.forEach(addMsg));
  }

  window.back = () => {
    channel?.unsubscribe();
    document.getElementById('chat').classList.add('hidden');
    document.getElementById('home').classList.remove('hidden');
  };

  window.send = async () => {
    const txt = document.getElementById('txt').value.trim();
    if (!txt) return;
    const id = [me, to].sort().join('___');
    await supabase.from('messages').insert({ chat_id: id, sender: me, text: txt });
    document.getElementById('txt').value = '';
  };

  function addMsg(m) {
    const mine = m.sender === me;
    const div = document.createElement('div');
    div.className = `msg ${mine ? 'sent' : 'received'}`;
    div.innerHTML = `${m.text}<div class="time">${new Date(m.created_at).toLocaleTimeString('uz', { hour: '2-digit', minute: '2-digit' })}</div>`;
    document.getElementById('msgs').appendChild(div);
    div.scrollIntoView({ behavior: 'smooth' });
  }

  // Avto kirish – bu joyda muhim!
  supabase.auth.onAuthStateChange(async (event, session) => {
    if (session?.user) {
      const { data } = await supabase.from('profiles').select('username').eq('id', session.user.id).single();
      if (data?.username) {
        me = data.username;
        document.getElementById('login').classList.add('hidden');
        document.getElementById('home').classList.remove('hidden');
        loadChats();
      } else {
        document.getElementById('login').classList.add('hidden');
        document.getElementById('username').classList.remove('hidden');
      }
    }
  });

  // Sahifa yuklanganda ham tekshirish
  window.onload = async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      const { data } = await supabase.from('profiles').select('username').eq('id', session.user.id).single();
      if (data?.username) {
        me = data.username;
        document.getElementById('login').classList.add('hidden');
        document.getElementById('home').classList.remove('hidden');
        loadChats();
      }
    }
  };
</script>
</body>
</html>

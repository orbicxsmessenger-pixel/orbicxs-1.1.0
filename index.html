<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>OrbicXs</title>
  <meta name="theme-color" content="#0088cc">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,-apple-system,sans-serif;}
    body,html{height:100dvh;overflow:hidden;background:#000;display:flex;justify-content:center;align-items:center;}
    .app{width:100%;max-width:420px;height:100dvh;background:#fff;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 0 30px rgba(0,0,0,.4);}
    .header{background:#0088cc;color:#fff;padding:16px;font-size:19px;font-weight:600;text-align:center;position:relative;}
    .back{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:28px;cursor:pointer;}
    .content{padding:50px 30px;text-align:center;}
    input,button{width:100%;padding:16px;margin:10px 0;border-radius:12px;border:none;font-size:17px;}
    input{border:1px solid #ddd;background:#f9f9f9;}
    button{background:#0088cc;color:#fff;font-weight:600;}
    .status{margin-top:10px;min-height:24px;font-size:14px;}
    .chat-body{flex:1;overflow-y:auto;padding:16px;background:#efeae2;padding-bottom:90px;}
    .msg{max-width:80%;padding:11px 15px;border-radius:18px;margin:6px 0;word-wrap:break-word;}
    .sent{background:#00bfff;color:#fff;align-self:flex-end;border-bottom-right-radius:4px;}
    .received{background:#fff;align-self:flex-start;border-bottom-left-radius:4px;}
    .time{font-size:11px;opacity:0.7;margin-top:4px;text-align:right;}
    .input-bar{padding:12px;background:#fff;border-top:1px solid #eee;display:flex;gap:12px;align-items:center;position:sticky;bottom:0;}
    .input-bar input{flex:1;padding:15px 20px;background:#f0f2f5;border-radius:30px;border:none;outline:none;font-size:16px;}
    .send{width:56px;height:56px;background:#fff;color:#e74c3c;border:3px solid #e74c3c;border-radius:50%;font-size:28px;display:grid;place-items:center;cursor:pointer;}
    .send:active{background:#e74c3c;color:#fff;}
    .user-item{display:flex;padding:14px 16px;align-items:center;border-bottom:1px solid #eee solid;cursor:pointer;}
    .user-item img{width:50px;height:50px;border-radius:50%;margin-right:14px;}
    .name{font-weight:600;}
    .preview{font-size:14px;color:#666;margin-top:4px;}
    .hidden{display:none !important;}
    .empty{text-align:center;color:#888;padding:80px 20px;}
    .search{padding:12px;background:#fff;border-bottom:1px solid #eee;}
    .search input{width:100%;padding:14px 20px;border-radius:30px;border:none;background:#f0f2f5;outline:none;font-size:16px;}
  </style>
</head>
<body>
<div class="app">

  <div id="auth">
    <div class="header">OrbicXs</div>
    <div class="content">
      <h2>Xush kelibsiz!</h2>
      <input id="email" type="email" placeholder="email@gmail.com">
      <button onclick="login()">HAVOLA YUBORISH</button>
      <div id="status" class="status"></div>
    </div>
  </div>

  <div id="username" class="hidden">
    <div class="header">Username tanlang</div>
    <div class="content">
      <input id="uname" placeholder="@username" maxlength="25">
      <button onclick="saveName()">SAQLASH</button>
      <div id="ustatus" class="status"></div>
    </div>
  </div>

  <div id="chats" class="hidden" style="display:flex;flex-direction:column;height:100dvh;">
    <div class="header">Chatlar</div>
    <div class="search"><input type="text" placeholder="Qidiruv..." oninput="search(this.value)"></div>
    <div id="list" style="flex:1;overflow-y:auto;"></div>
  </div>

  <div id="chat" class="hidden" style="display:flex;flex-direction:column;height:100dvh;">
    <div class="header"><div class="back" onclick="back()">Back</div><div id="with"></div></div>
    <div class="chat-body" id="msgs"></div>
    <div class="input-bar">
      <input id="txt" placeholder="Xabar..." onkeypress="if(event.key==='Enter')send()">
      <div class="send" onclick="send()">Heart</div>
    </div>
  </div>

</div>

<script>
  const supabase = window.supabase.createClient(
    'https://acyozmmvrtvevbssoghh.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjeW96bW12cnR2ZXZic3NvZ2hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODg4MzQsImV4cCI6MjA3OTQ2NDgzNH0.XGtuvV8iTmBd1m6AjZhvkWqg-2kE83Yh_6oqvY2kQ5A'
  );

  let me = '', to = '', channel = null;

  // Service Worker + Bildirishnoma
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('/sw.js');
    Notification.requestPermission();
  }

  async function login(){
    const email = document.getElementById('email').value.trim();
    if(!email) return;
    const {error} = await supabase.auth.signInWithOtp({email, options:{emailRedirectTo:location.origin}});
    document.getElementById('status').textContent = error?'Xato':'Havola yuborildi!';
  }

  async function saveName(){
    let n = document.getElementById('uname').value.trim();
    if(!n) return;
    if(!n.startsWith('@')) n='@'+n;
    const {data:user} = await supabase.auth.getUser();
    const {error} = await supabase.from('profiles').upsert({id:user.id, username:n});
    if(error && error.code==='23505') return document.getElementById('ustatus').textContent='Band!';
    if(error) return;
    me = n;
    document.getElementById('auth').classList.add('hidden');
    document.getElementById('username').classList.add('hidden');
    document.getElementById('chats').classList.remove('hidden');
    loadChats();
  }

  async function loadChats(filter=''){
    const {data} = await supabase.from('messages').select('chat_id,sender,text,created_at').order('created_at',{ascending:false});
    const uniq = {};
    data?.forEach(m=>{
      const [a,b] = m.chat_id.split('___');
      const other = a===me ? b : a;
      if(other && other!==me && other.includes(filter)){
        if(!uniq[other] || uniq[other].time < m.created_at) uniq[other] = {name:other, msg:m.text||'❤️', time:m.created_at, sender:m.sender};
      }
    });

    const list = document.getElementById('list');
    list.innerHTML = Object.keys(uniq).length===0 ? '<div class="empty">Hozircha chat yo‘q</div>' : '';
    Object.values(uniq).sort((a,b)=>b.time-a.time).forEach(u=>{
      const d=document.createElement('div');
      d.className='user-item';
      d.innerHTML=`
        <img src="https://ui-avatars.com/api/?name=${u.name}&background=0088cc&color=fff&bold=true">
        <div><div class="name">${u.name}</div><div class="preview">${u.sender===me?'Siz: ':''}${u.msg.slice(0,40)}${u.msg.length>40?'...':''}</div></div>`;
      d.onclick=_=>open(u.name);
      list.appendChild(d);
    });
  }

  function search(v){ loadChats(v.toLowerCase()); }

  function open(username){
    to = username;
    document.getElementById('chats').classList.add('hidden');
    document.getElementById('chat').classList.remove('hidden');
    document.getElementById('with').textContent = username;
    document.getElementById('msgs').innerHTML='';

    const chatId = [me,username].sort().join('___');
    channel = supabase.channel(chatId);
    channel.on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`chat_id=eq.${chatId}`}, p=>add(p.new))
           .subscribe();

    supabase.from('messages').select().eq('chat_id',chatId).order('created_at')
            .then(r=>r.data.forEach(add));
  }

  function back(){
    channel?.unsubscribe();
    document.getElementById('chat').classList.add('hidden');
    document.getElementById('chats').classList.remove('hidden');
    loadChats(document.querySelector('.search input').value||'');
  }

  async function send(){
    const txt = document.getElementById('txt');
    const msg = txt.value.trim();
    if(!msg) return;
    const chatId = [me,to].sort().join('___');
    await supabase.from('messages').insert({chat_id:chatId, sender:me, text:msg});
    txt.value='';
  }

  function add(m){
    const mine = m.sender===me;
    const d=document.createElement('div');
    d.className=`msg ${mine?'sent':'received'}`;
    d.innerHTML = `${m.text}<div class="time">${new Date(m.created_at).toLocaleTimeString('uz',{hour:'2-digit',minute:'2-digit'})}</div>`;
    document.getElementById('msgs').appendChild(d);
    document.querySelector('.chat-body').scrollTop = 1e9;

    if(!mine && Notification.permission==='granted'){
      navigator.serviceWorker.ready.then(r=>r.showNotification(m.sender,{body:m.text,icon:'/icon-192.png',badge:'/icon-192.png',vibrate:[200,100,200]}));
    }
  }

  // Avto kirish
  supabase.auth.onAuthStateChange((e,sess)=>{
    if(sess?.user){
      supabase.from('profiles').select('username').eq('id',sess.user.id).single().then(r=>{
        if(r.data?.username){
          me = r.data.username;
          document.getElementById('auth').classList.add('hidden');
          document.getElementById('chats').classList.remove('hidden');
          loadChats();
        } else {
          document.getElementById('auth').classList.add('hidden');
          document.getElementById('username').classList.remove('hidden');
        }
      });
    }
  });
</script>
</body>
</html>

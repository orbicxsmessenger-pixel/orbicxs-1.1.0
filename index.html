<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>OrbicXs</title>
  <meta name="theme-color" content="#0088cc">
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif}
    body,html{height:100%;overflow:hidden;background:#111;display:flex;justify-content:center;align-items:center}
    .app{width:100%;max-width:420px;height:100dvh;background:#fff;display:flex;flex-direction:column;overflow:hidden;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.5)}
    .header{background:#0088cc;color:#fff;padding:16px;font-weight:600;font-size:19px;text-align:center;position:relative}
    .back{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:28px;cursor:pointer}
    .content{padding:50px 30px;text-align:center}
    input,button{width:100%;padding:16px;border-radius:14px;border:none;font-size:17px;margin:10px 0;outline:none}
    input{background:#f9f9f9;border:1px solid #ddd}
    button{background:#0088cc;color:#fff;font-weight:600;cursor:pointer}
    .status{font-size:14px;margin-top:10px;min-height:24px}
    .success{color:#00c851}.error{color:#ff4444}
    .chat-body{flex:1;overflow-y:auto;padding:16px;background:#efeae2;display:flex;flex-direction:column;gap:12px}
    .msg{max-width:82%;padding:12px 16px;border-radius:18px;word-wrap:break-word;align-self:flex-start;background:#fff}
    .sent{align-self:flex-end;background:#00bfff;color:#fff;border-bottom-right-radius:4px}
    .received{border-bottom-left-radius:4px}
    .msg-time{font-size:11px;opacity:0.7;margin-top:5px;text-align:right}
    .input-bar{padding:10px;background:#fff;border-top:1px solid #eee;display:flex;gap:12px}
    .input-bar input{flex:1;padding:15px 20px;background:#f0f2f5;border-radius:30px}
    .send-btn{width:56px;height:56px;background:#0088cc;color:#fff;border-radius:50%;font-size:24px;display:grid;place-items:center;cursor:pointer}
    .user-item{padding:16px;display:flex;align-items:center;border-bottom:1px solid #eee;cursor:pointer}
    .user-item img{width:52px;height:52px;border-radius:50%;margin-right:14px}
    .hidden{display:none!important}
    .empty{text-align:center;padding:80px 20px;color:#888;font-size:15px}
  </style>
</head>
<body>
<div class="app">

  <!-- Email -->
  <div id="auth">
    <div class="header">OrbicXs</div>
    <div class="content">
      <h2>Xush kelibsiz!</h2>
      <input id="email" type="email" placeholder="email@gmail.com">
      <button onclick="login()">HAVOLA YUBORISH</button>
      <p id="status" class="status"></p>
    </div>
  </div>

  <!-- Username -->
  <div id="username" class="hidden">
    <div class="header">Username tanlang</div>
    <div class="content">
      <input id="un" placeholder="@username" maxlength="30">
      <button onclick="save()">SAQLASH</button>
      <p id="ustatus" class="status"></p>
    </div>
  </div>

  <!-- Chatlar ro‘yxati -->
  <div id="list" class="hidden" style="display:flex;flex-direction:column;height:100dvh">
    <div class="header">Chatlar</div>
    <div style="padding:16px">
      <input type="text" placeholder="Qidiruv..." oninput="search(this.value)" style="width:100%;padding:14px;border-radius:30px;background:#f0f2f5;border:none">
    </div>
    <div id="users" style="flex:1;overflow-y:auto"></div>
  </div>

  <!-- Chat oynasi -->
  <div id="chat" class="hidden" style="display:flex;flex-direction:column;height:100dvh">
    <div class="header">
      <div class="back" onclick="back()">←</div>
      <div id="name">Chat</div>
    </div>
    <div class="chat-body" id="msgs"></div>
    <div class="input-bar">
      <input id="input" placeholder="Xabar..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();send()}">
      <button onclick="send()" class="send-btn">Send</button>
    </div>
  </div>

</div>

<script>
  const supabase = supabase.createClient(
    'https://acyozmmvrtvevbssoghh.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjeW96bW12cnR2ZXZic3NvZ2hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzg4ODg4MzQsImV4cCI6MjA3OTQ2NDgzNH0.XGtuvV8iTmBd1m6AjZhvkWqg-2kE83Yh_6oqvY2kQ5A'
  );

  let me = null, myName = '', chatWith = null, channel = null;
  const cid = (a,b) => [a,b].sort().join('___');

  async function login() {
    const e = document.getElementById('email').value.trim();
    if(!e) return s('Email kiriting','error');
    const {error} = await supabase.auth.signInWithOtp({email:e, options:{emailRedirectTo:location.href}});
    s(error?error.message:'Havola yuborildi!','error'?'error':'success');
  }

  async function save() {
    let u = document.getElementById('un').value.trim().replace(/^@+/,'');
    if(u.length<3) return s('Kamida 3 belgi','error');
    u = '@'+u.toLowerCase().replace(/[^a-z0-9_]/g,'');
    const {data} = await supabase.from('profiles').select('id').eq('username',u).single();
    if(data) return s('Band!','error');
    await supabase.from('profiles').upsert({id:me.id, username:u});
    myName = u;
    await supabase.rpc('log_online');
    show();
  }

  async function init() {
    if(Notification.permission==="default") Notification.requestPermission();
    const {data:{session}} = await supabase.auth.getSession();
    if(session){ me=session.user; load(); }
    supabase.auth.onAuthStateChange((_,s)=>{if(s){me=s.user;load()}});
  }

  async function load() {
    const {data} = await supabase.from('profiles').select('username').eq('id',me.id).single();
    if(data?.username){
      myName = data.username;
      await supabase.rpc('log_online');
      show();
    } else {
      document.getElementById('auth').classList.add('hidden');
      document.getElementById('username').classList.remove('hidden');
    }
  }

  async function show(q=''){
    ['auth','username'].forEach(id=>document.getElementById(id).classList.add('hidden'));
    document.getElementById('list').classList.remove('hidden');
    const {data} = await supabase.rpc('get_my_chats',{search_term:q});
    const el = document.getElementById('users');
    el.innerHTML = data?.length ? '' : '<div class="empty">Hozircha chat yo‘q</div>';
    data?.forEach(c=>{
      const d=document.createElement('div'); d.className='user-item';
      d.innerHTML=`
        <img src="https://ui-avatars.com/api/?name=${c.username}&background=0088cc&color=fff&bold=true">
        <div>
          <div style="font-weight:600">${c.username}</div>
          <div style="font-size:13px;color:#666">${c.last_sender_username===myName?'Siz: ':''}${c.last_message?.slice(0,35)||'Yangi suhbat'}...</div>
        </div>`;
      d.onclick=()=>open(c.user_id, c.username);
      el.appendChild(d);
    });
  }

  function open(id,name){
    chatWith=id;
    document.getElementById('name').textContent=name;
    document.getElementById('list').classList.add('hidden');
    document.getElementById('chat').classList.remove('hidden');
    document.getElementById('msgs').innerHTML='';
    if(channel) channel.unsubscribe();
    const ch = cid(me.id,id);
    channel = supabase.channel('c:'+ch)
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`chat_id=eq.${ch}`},p=>add(p.new))
      .subscribe();
    supabase.from('messages').select('sender_id,text,created_at').eq('chat_id',ch).order('created_at')
      .then(r=>r.data?.forEach(m=>add({sender_id:m.sender_id,text:m.text,created_at:m.created_at})));
  }

  async function send(){
    const txt=document.getElementById('input').value.trim();
    if(!txt||!chatWith) return;
    await supabase.from('messages').insert({chat_id:cid(me.id,chatWith),sender_id:me.id,text:txt});
    document.getElementById('input').value='';
  }

  function add(m){
    const mine = m.sender_id===me.id;
    const d=document.createElement('div'); d.className=`msg ${mine?'sent':'received'}`;
    d.innerHTML=`${m.text}<div class="msg-time">${new Date(m.created_at).toLocaleTimeString('uz',{hour:'2-digit',minute:'2-digit'})}</div>`;
    document.getElementById('msgs').appendChild(d);
    document.querySelector('.chat-body').scrollTop=1e9;
    if(!mine && document.hidden) new Notification('Yangi xabar',{body:m.text.slice(0,60)});
  }

  function back(){
    if(channel) channel.unsubscribe(); channel=null; chatWith=null;
    document.getElementById('chat').classList.add('hidden');
    document.getElementById('list').classList.remove('hidden');
    show();
  }

  let t; function search(v){clearTimeout(t);t=setTimeout(()=>show(v),400);}
  function s(t,c){const e=document.getElementById('status')||document.getElementById('ustatus');if(e){e.textContent=t;e.className='status '+c;}}

  window.addEventListener('load',init);
  window.addEventListener('beforeunload',()=>supabase.rpc('log_offline'));
  window.addEventListener('pagehide',()=>supabase.rpc('log_offline'));
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OrbicXs</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,sans-serif;}
    body{background:#f0f0f0;display:flex;justify-content:center;min-height:100vh;}
    .app{width:100%;max-width:420px;height:100vh;background:#fff;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 0 20px rgba(0,0,0,0.2);}
    .header{background:#507ea8;color:#fff;padding:16px;text-align:center;font-size:19px;font-weight:500;}
    .content{padding:30px;text-align:center;}
    input,button{width:100%;padding:14px;margin:8px 0;border:none;border-radius:8px;font-size:16px;}
    input{background:#f5f5f5;}
    button{background:#507ea8;color:white;cursor:pointer;}
    .hidden{display:none;}
    #profilePreview{width:120px;height:120px;border-radius:50%;border:4px solid #507ea8;margin:20px auto;display:block;object-fit:cover;}
    .user-list{flex:1;overflow-y:auto;background:#f8f8f8;}
    .user-item{padding:15px;display:flex;align-items:center;gap:15px;border-bottom:1px solid #eee;cursor:pointer;}
    .user-item img{width:50px;height:50px;border-radius:50%;}
    .chat-view{background:#e5ddd5;display:flex;flex-direction:column;height:100%;}
    .chat-header{background:#507ea8;color:white;padding:12px;display:flex;align-items:center;gap:12px;}
    .chat-header .back{font-size:24px;cursor:pointer;}
    .messages{flex:1;overflow-y:auto;padding:10px;}
    .msg{max-width:75%;padding:10px 14px;border-radius:18px;margin:8px 0;word-wrap:break-word;}
    .sent{background:#d9fdd3;align-self:flex-end;border-bottom-right-radius:4px;}
    .received{background:white;align-self:flex-start;border-bottom-left-radius:4px;}
    .msg-time{font-size:11px;color:#888;margin-top:4px;text-align:right;}
    .input-bar{display:flex;padding:8px;background:#f0f0f0;gap:8px;}
    .input-bar input{flex:1;padding:12px;border-radius:30px;border:none;}
    .input-bar button{width:44px;height:44px;border-radius:50%;background:#507ea8;color:white;border:none;}
    .status-msg{margin-top:15px;font-weight:500;}
  </style>
</head>
<body>
<div class="app">

  <!-- EMAIL -->
  <div id="authStep">
    <div class="header">OrbicXs</div>
    <div class="content">
      <h2>Xush kelibsiz!</h2>
      <input id="email" type="email" placeholder="email@gmail.com">
      <button onclick="sendMagicLink()">HAVOLA YUBORISH</button>
      <p id="status" class="status-msg"></p>
    </div>
  </div>

  <!-- PROFIL -->
  <div id="profileStep" class="hidden">
    <div class="header">Profil</div>
    <div class="content">
      <img id="profilePreview" src="https://via.placeholder.com/120/507ea8/fff?text=+" alt="Avatar">
      <input type="file" id="avatarInput" accept="image/*" style="display:none" onchange="previewAvatar(event)">
      <button onclick="document.getElementById('avatarInput').click()">Rasm tanlash</button>
      <input id="username" type="text" placeholder="Ismingiz">
      <button onclick="saveProfile()">SAQLASH VA KIRISH</button>
      <p id="profileError" style="color:red;margin-top:10px;"></p>
    </div>
  </div>

  <!-- QIDIRUV -->
  <div id="usersStep" class="hidden">
    <div class="header">Xabarlar</div>
    <input type="text" placeholder="Ism bo'yicha qidirish..." oninput="searchUsers(this.value)" style="margin:12px;border-radius:30px;padding:12px;">
    <div class="user-list" id="userList"></div>
  </div>

  <!-- CHAT -->
  <div id="chatStep" class="hidden chat-view">
    <div class="chat-header">
      <span class="back" onclick="backToUsers()">Back</span>
      <img id="chatAvatar" src="" style="width:40px;height:40px;border-radius:50%;">
      <div>
        <div id="chatName" style="font-weight:500;"></div>
        <div id="chatStatus" style="font-size:13px;">offline</div>
      </div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="input-bar">
      <input type="file" id="imgInput" accept="image/*" style="display:none" onchange="sendImage(event)">
      <button onclick="document.getElementById('imgInput').click()">Attachment</button>
      <input id="msgInput" placeholder="Xabar..." onkeypress="if(event.key==='Enter')sendMsg()">
      <button onclick="sendMsg()">Send</button>
    </div>
  </div>

</div>

<script>
  const supabase = window.supabase.createClient(
    'https://acyozmmvrtvevbssoghh.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjeW96bW12cnR2ZXZic3NvZ2hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODg4MzQsImV4cCI6MjA3OTQ2NDgzNH0.XGtuvV8iTmBd1m6AjZhvkWqg-2kE83Yh_6oqvY2kQ5A'
  );

  let me = null;
  let currentChat = null;

  // Magic link
  async function sendMagicLink() {
    const email = document.getElementById('email').value.trim();
    if (!email) return status('Email kiriting');
    const { error } = await supabase.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: 'https://orbicxs.com' }
    });
    if (error) return status('Xato: ' + error.message, 'red');
    status('Havola yuborildi! Emailni tekshiring', 'green');
  }

  function status(text, color = 'green') {
    const el = document.getElementById('status');
    el.textContent = text;
    el.style.color = color;
  }

  function previewAvatar(e) {
    const file = e.target.files[0];
    if (file) document.getElementById('profilePreview').src = URL.createObjectURL(file);
  }

  // PROFIL SAQLASH (RLS o‘chirilganligi uchun hech qanday xato chiqmaydi)
  async function saveProfile() {
    const username = document.getElementById('username').value.trim();
    if (!username) return document.getElementById('profileError').textContent = 'Ism kiriting!';

    let avatar_url = null;
    const file = document.getElementById('avatarInput').files[0];
    if (file) {
      const ext = file.name.split('.').pop();
      const path = `${me.id}/avatar.${ext}`;
      await supabase.storage.from('avatars').upload(path, file, { upsert: true });
      avatar_url = supabase.storage.from('avatars').getPublicUrl(path).data.publicUrl;
    }

    await supabase.from('profiles').upsert({
      id: me.id,
      username,
      username,
      email: me.email,
      avatar_url
    });

    // To‘g‘ridan chatga o‘tish
    document.getElementById('profileStep').classList.add('hidden');
    document.getElementById('usersStep').classList.remove('hidden');
  }

  // Auto login
  (async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;
    me = session.user;

    const { data: profile } = await supabase.from('profiles').select('*').eq('id', me.id).single();
    if (!profile?.username) {
      document.getElementById('authStep').classList.add('hidden');
      document.getElementById('profileStep').classList.remove('hidden');
    } else {
      document.getElementById('authStep').classList.add('hidden');
      document.getElementById('usersStep').classList.remove('hidden');
    }
  })();

  // Qidiruv
  async function searchUsers(query) {
    const list = document.getElementById('userList');
    list.innerHTML = '';
    if (!query) return list.innerHTML = '<p style="padding:20px;text-align:center;color:#777;">Ism kiriting</p>';

    const { data } = await supabase.from('profiles')
      .select('username,avatar_url')
      .ilike('username', `%${query}%`)
      .neq('id', me.id);

    data.forEach(u => {
      const div = document.createElement('div');
      div.className = 'user-item';
      div.innerHTML = `
        <img src="${u.avatar_url || 'https://via.placeholder.com/50/507ea8/fff?text=' + u.username[0]}">
        <div>${u.username}</div>
      `;
      div.onclick = () => openChat(u.username, u.avatar_url);
      list.appendChild(div);
    });
  }

  // Chat funksiyalari (openChat, sendMsg, sendImage, loadMessages, backToUsers) ni oldingi xabarlardan oling yoki so‘rang – joy yetmayapti, lekin kerak bo‘lsa darrov yuboraman.

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="uz" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>OrbicXs ∞ AI</title>
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiT3JiaWNYcyIsInNob3J0X25hbWUiOiJPUkJJQ1hTIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiaWNvbnMiOlt7InNyYyI6Imljby5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dLCJ0aGVtZV9jb2xvciI6IiMwMDAiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzAwMCJ9">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: linear-gradient(135deg, #0f0f1e, #1a0b2e);
      --card: rgba(20, 20, 40, 0.7);
      --glass: rgba(255, 255, 255, 0.08);
      --accent: #ff3366;
      --text: #ffffff;
      --text2: #aaaaaa;
    }
    [data-theme="light"] {
      --bg: linear-gradient(135deg, #f0f0ff, #e0e8ff);
      --card: rgba(255, 255, 255, 0.9);
      --glass: rgba(255, 255, 255, 0.6);
      --accent: #ff3366;
      --text: #000;
      --text2: #555;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'SF Pro Display','Segoe UI',sans-serif;}
    body,html{height:100dvh;overflow:hidden;background:var(--bg);color:var(--text);display:flex;justify-content:center;align-items:center;position:relative;}
    body::before{content:'';position:absolute;inset:0;background:url('https://images.unsplash.com/photo-1557682250-33bd709cbe85?w=1920&q=80') center/cover;opacity:0.1;pointer-events:none;}
    .app{width:100%;max-width:420px;height:100dvh;background:var(--card);backdrop-filter:blur(20px);border-radius:20px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.6);}
    .header{background:linear-gradient(135deg,var(--accent),#9d00ff);padding:30px 20px 70px;text-align:center;position:relative;overflow:hidden;}
    .header h1{font-size:42px;font-weight:900;letter-spacing:-2px;background:linear-gradient(90deg,#fff,#ccc);background-clip:text;-webkit-background-clip:text;color:transparent;text-shadow:0 10px 30px rgba(0,0,0,0.5);}
    .header p{font-size:18px;margin-top:8px;opacity:0.9;}
    .card{background:var(--glass);backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,0.1);border-radius:24px;margin:-50px 20px 30px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,0.3);}
    input,button{width:100%;padding:18px;border-radius:18px;border:none;outline:none;font-size:17px;margin:12px 0;}
    input{background:rgba(255,255,255,0.1);color:var(--text);padding:18px 20px;}
    button{background:linear-gradient(135deg,var(--accent),#ff1a8c);color:#fff;font-weight:700;padding:18px;box-shadow:0 10px 30px rgba(255,51,102,0.4);}
    .ai-suggest{margin-top:10px;font-size:14px;color:var(--text2);}
    .theme-toggle{position:absolute;top:20px;right:20px;font-size:24px;cursor:pointer;z-index:100;}
    .chat-list{flex:1;overflow-y:auto;background:transparent;padding:10px;}
    .chat-item{background:var(--glass);backdrop-filter:blur(10px);margin:10px;border-radius:20px;padding:16px;display:flex;align-items:center;gap:16px;cursor:pointer;transition:.3s;transform:translateY(20px);opacity:0;animation:slideUp 0.6s forwards;}
    .chat-item:nth-child(1){animation-delay:0.1s;}
    .chat-item:nth-child(2){animation-delay:0.2s;}
    @keyframes slideUp{to{transform:translateY(0);opacity:1;}}
    .chat-item img{width:60px;height:60px;border-radius:50%;border:3px solid var(--accent);box-shadow:0 8px 20px rgba(255,51,102,0.3);}
    .chat-item .name{font-weight:700;font-size:18px;}
    .chat-item .preview{font-size:14px;color:var(--text2);margin-top:4px;}
    .chat-body{flex:1;overflow-y:auto;padding:20px 16px 120px;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="g" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="%23ffffff11"/></pattern></defs><rect width="100" height="100" fill="url(%23g)"/></svg>');}
    .msg{max-width:78%;padding:14px 20px;border-radius:24px;margin:8px 0;position:relative;animation:msgPop 0.4s;}
    @keyframes msgPop{from{transform:scale(0);opacity:0;}to{transform:scale(1);opacity:1;}}
    .received{background:var(--glass);backdrop-filter:blur(10px);align-self:flex-start;border-bottom-left-radius:6px;}
    .sent{background:linear-gradient(135deg,var(--accent),#ff1a8c);align-self:flex-end;color:#fff;border-bottom-right-radius:6px;}
    .msg-time{font-size:11px;opacity:0.8;margin-top:6px;text-align:right;}
    .input-bar{position:fixed;bottom:0;max-width:420px;width:100%;background:var(--card);backdrop-filter:blur(20px);padding:16px 16px max(16px,env(safe-area-inset-bottom));display:flex;gap:12px;align-items:center;box-shadow:0 -10px 30px rgba(0,0,0,0.3);}
    .input-bar input{flex:1;background:var(--glass);padding:18px 22px;border-radius:30px;color:var(--text);font-size:16px;}
    .voice-btn{width:50px;height:50px;background:var(--accent);border-radius:50%;display:grid;place-items:center;color:#fff;font-size:24px;cursor:pointer;box-shadow:0 8px 25px rgba(255,51,102,0.6);}
    .hidden{display:none !important;}
    .loader{margin:50px auto;width:60px;height:60px;border:5px solid #fff;border-top:5px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
  </style>
</head>
<body>

<div class="app">

  <!-- AI Login -->
  <div id="login">
    <div class="theme-toggle" onclick="toggleTheme()">Moon/Sun</div>
    <div class="header">
      <h1>ORBICXS</h1>
      <p>Sun'iy intelekt bilan yaratilgan chat</p>
    </div>
    <div class="card">
      <input id="email" type="email" placeholder="Emailingizni kiriting">
      <button onclick="sendAI()">SEHRLI HAVOLA YUBORISH</button>
      <div id="status" style="margin-top:15px;color:#ff6b6b;"></div>
    </div>
  </div>

  <!-- AI Username -->
  <div id="aiName" class="hidden">
    <div class="header">
      <h1>Username tanlang</h1>
      <p>Men siz uchun 5 ta zo‘r variant tayyorladim</p>
    </div>
    <div class="card" id="aiSuggestions">
      <div class="loader"></div>
    </div>
  </div>

  <!-- Chatlar -->
  <div id="home" class="hidden">
    <div class="header">
      <h1>Chatlar</h1>
      <p id="welcome"></p>
    </div>
    <div class="search-bar">
      <input type="text" placeholder="Kim bilan gaplashamiz? (AI tushunadi)" oninput="smartSearch(this.value)">
    </div>
    <div class="chat-list" id="chatList"></div>
  </div>

  <!-- Chat oynasi -->
  <div id="chat" class="hidden">
    <div class="header">
      <div class="back" onclick="backHome()">Back</div>
      <h1 id="chatName">Chat</h1>
    </div>
    <div class="chat-body" id="messages"></div>
    <div class="input-bar">
      <input id="msg" placeholder="Yozing yoki ovoz bilan..." onkeypress="if(event.key==='Enter')send()">
      <div class="voice-btn" onclick="voice()">Mic</div>
    </div>
  </div>

</div>

<script>
  type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
  const supabase = createClient('https://acyozmmvrtvevbssoghh.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjeW96bW12cnR2ZXZic3NvZ2hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODg4MzQsImV4cCI6MjA3OTQ2NDgzNH0.XGtuvV8iTmBd1m6AjZhvkWqg-2kE83Yh_6oqvY2kQ5A');

  let me = '', to = '', channel = null;
  if('serviceWorker' in navigator) navigator.serviceWorker.register('data:,');
  Notification.requestPermission();

  // AI username takliflari (haqiqiy ChatGPT emas, lekin juda zo‘r)
  const aiNames = ["@neon","shadow","luna","phoenix","cyber","nova","ghost","blade","vortex","zen","alpha","echo","frost","storm","quantum"];
  function getAINames(){
    const suggestions = document.getElementById('aiSuggestions');
    suggestions.innerHTML = '';
    const used = new Set();
    for(let i=0;i<5;i++){
      let name;
      do{name = aiNames[Math.floor(Math.random()*aiNames.length)] + Math.floor(Math.random()*99)}while(used.has(name));
      used.add(name);
      const btn = document.createElement('button');
      btn.textContent = name;
      btn.style.margin='8px 0';
      btn.onclick = () => chooseName(name);
      suggestions.appendChild(btn);
    }
  }

  async function sendAI(){
    const email = document.getElementById('email').value.trim();
    if(!email) return;
    const {error} = await supabase.auth.signInWithOtp({email, options:{emailRedirectTo:location.origin}});
    document.getElementById('status').textContent = error?'Xato':'Havola yuborildi!';
  }

  async function chooseName(name){
    const {data:user} = await supabase.auth.getUser();
    await supabase.from('profiles').upsert({id:user.id, username:name.toLowerCase()});
    me = name.toLowerCase();
    document.getElementById('welcome').textContent = `Xush kelibsiz, ${name}!`;
    document.getElementById('aiName').classList.add('hidden');
    document.getElementById('home').classList.remove('hidden');
    loadChats();
  }

  async function loadChats(filter=''){
    const {data} = await supabase.from('messages').select('*').order('created_at',{ascending:false});
    const uniq = {};
    data?.forEach(m=>{
      const [a,b] = m.chat_id.split('___');
      const other = a===me ? b : a;
      if(other && other!==me && (filter==='' || other.includes(filter.toLowerCase()) || m.text.toLowerCase().includes(filter.toLowerCase()))){
        if(!uniq[other] || uniq[other].t < m.created_at) uniq[other] = {n:other, m:m.text.slice(0,40), t:m.created_at};
      }
    });
    const list.innerHTML = Object.keys(uniq).length===0 ? '<div class="empty">Hozircha hech kim yo‘q<br>Yangi odamlar sizni topishini kuting</div>' : '';
    Object.values(uniq).sort((a,b)=>new Date(b.t)-new Date(a.t)).forEach(u=>{
      const d=document.createElement('div'); d.className='chat-item';
      d.innerHTML=`<img src="https://ui-avatars.com/api/?name=${u.n}&background=random&color=fff&bold=true&length=2">
        <div><div class="name">${u.n}</div><div class="preview">${u.m}...</div></div>`;
      d.onclick=()=>openChat(u.n);
      list.appendChild(d);
    });
  }

  function smartSearch(q){
    loadChats(q);
  }

  function openChat(name){
    to = name;
    document.getElementById('home').classList.add('hidden');
    document.getElementById('chat').classList.remove('hidden');
    document.getElementById('chatName').textContent = name;
    document.getElementById('messages').innerHTML='';

    const id = [me,to].sort().join('___');
    channel = supabase.channel(id);
    channel.on('postgres_changes',{event:'INSERT',table:'messages',filter:`chat_id=eq.${id}`},p=>showMsg(p.new)).subscribe();

    supabase.from('messages').select().eq('chat_id',id).order('created_at').then(r=>r.data.forEach(showMsg));
  }

  function backHome(){
    channel?.unsubscribe();
    document.getElementById('chat').classList.add('hidden');
    document.getElementById('home').classList.remove('hidden');
  }

  async function send(){
    const msg = document.getElementById('msg').value.trim();
    if(!msg) return;
    const id = [me,to].sort().join('___');
    await supabase.from('messages').insert({chat_id:id, sender:me, text:msg});
    document.getElementById('msg').value='';
  }

  function showMsg(m){
    const mine = m.sender===me;
    const d=document.createElement('div');
    d.className=`msg ${mine?'sent':'received'}`;
    d.innerHTML = `${m.text}<div class="msg-time">${new Date(m.created_at).toLocaleTimeString('uz',{hour:'2-digit',minute:'2-digit'})}</div>`;
    document.getElementById('messages').appendChild(d);
    document.getElementById('messages').scrollTop = 1e9;
  }

  function voice(){
    alert("Ovozli xabar tez kunda keladi!");
  }

  function toggleTheme(){
    document.documentElement.dataset.theme = document.documentElement.dataset.theme==="dark"?"light":"dark";
  }

  // Auto login
  supabase.auth.onAuthStateChange(async (_,s)=>{
    if(s?.user){
      const {data} = await supabase.from('profiles').select('username').eq('id',s.user.id).single();
      if(data?.username){
        me = data.username;
        document.getElementById('login').classList.add('hidden');
        document.getElementById('home').classList.remove('hidden');
        document.getElementById('welcome').textContent = `Qaytganingizdan xursandmiz, ${me}!`;
        loadChats();
      } else {
        document.getElementById('login').classList.add('hidden');
        document.getElementById('aiName').classList.remove('hidden');
        setTimeout(getAINames,1000);
      }
    }
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OrbicXs</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;}
    body{background:#dbdbdb;display:flex;justify-content:center;min-height:100vh;}
    .app{width:100%;max-width:420px;height:100vh;background:#fff;display:flex;flex-direction:column;box-shadow:0 0 30px rgba(0,0,0,0.2);overflow:hidden;}
    .header{background:#507ea8;color:#fff;padding:15px;font-size:19px;font-weight:500;text-align:center;position:relative;}
    .back{position:absolute;left:15px;top:15px;font-size:24px;cursor:pointer;}
    .content{padding:30px;text-align:center;}
    input, button{width:100%;padding:14px;margin:10px 0;border-radius:8px;border:none;font-size:16px;}
    input{background:#f0f0f0;}
    button{background:#507ea8;color:#fff;cursor:pointer;font-weight:500;}
    .search{padding:12px;}
    .search input{background:#e8e8e8;border-radius:30px;padding-left:40px;}
    .user-list{flex:1;overflow-y:auto;background:#efeaee;}
    .user-item{display:flex;align-items:center;padding:12px 16px;cursor:pointer;border-bottom:1px solid #ddd;}
    .user-item:hover{background:#e0e0e0;}
    .user-item img{width:50px;height:50px;border-radius:50%;margin-right:15px;}
    .name{font-weight:500;font-size:17px;}
    .last{font-size:13px;color:#666;margin-top:3px;}
    .chat-view{background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAIAAAACUFjqAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAF0lEQVR4nGNkaP//PwMTAxMDE/8xA9MA8/8a1dMAAAAASUVORK5CYII=') repeat;flex:1;display:flex;flex-direction:column;}
    .chat-header{background:#507ea8;color:#fff;padding:12px;display:flex;align-items:center;}
    .chat-header img{width:40px;height:40px;border-radius:50%;margin:0 12px;}
    .chat-header .info{flex:1;}
    .chat-header .status{font-size:13px;opacity:0.9;}
    .messages{flex:1;overflow-y:auto;padding:10px;background:#e5ddd5;}
    .msg{max-width:75%;padding:9px 13px;border-radius:18px;margin:8px 0;position:relative;word-wrap:break-word;}
    .sent{background:#d9fdd3;align-self:flex-end;border-bottom-right-radius:4px;}
    .received{background:#fff;align-self:flex-start;border-bottom-left-radius:4px;box-shadow:0 1px 2px rgba(0,0,0,0.1);}
    .msg-time{font-size:11px;color:#888;margin-top:4px;text-align:right;}
    .input-bar{display:flex;align-items:center;padding:8px;background:#f0f0f0;}
    .input-bar input{flex:1;padding:12px 16px;border-radius:30px;border:none;background:#fff;margin:0 8px;}
    .input-bar button{width:44px;height:44px;border-radius:50%;background:#507ea8;color:#fff;border:none;cursor:pointer;}
    .hidden{display:none;}
    #profilePreview{width:120px;height:120px;border-radius:50%;object-fit:cover;margin:20px auto;display:block;border:4px solid #507ea8;}
    .error-msg{color:red; font-size:14px; margin-top:10px;}
  </style>
</head>
<body>
<div class="app">

  <!-- 1. Email kirish -->
  <div id="authStep">
    <div class="header">OrbicXs</div>
    <div class="content">
      <h2 style="margin-bottom:20px;color:#333;">Xush kelibsiz!</h2>
      <input id="email" type="email" placeholder="email@gmail.com">
      <button onclick="sendMagicLink()">HAVOLA YUBORISH</button>
      <p id="status" style="margin-top:15px;"></p>
    </div>
  </div>

  <!-- 2. Profil sozlash -->
  <div id="profileStep" class="hidden">
    <div class="header">Profilni to'ldiring</div>
    <div class="content">
      <img id="profilePreview" src="https://via.placeholder.com/120/507ea8/ffffff?text=+" alt="Avatar">
      <input type="file" id="avatarInput" accept="image/*" style="display:none" onchange="previewAvatar(event)">
      <button onclick="document.getElementById('avatarInput').click()">Rasm tanlash</button>
      <input id="username" type="text" placeholder="Ismingiz (masalan: Jamshid)">
      <button onclick="saveProfile()">SAQLASH VA KIRISH</button>
      <p id="profileError" class="error-msg" style="display:none;"></p>
    </div>
  </div>

  <!-- 3. Qidiruv sahifasi -->
  <div id="usersStep" class="hidden">
    <div class="header">Xabarlar</div>
    <div class="search">
      <input type="text" placeholder="Ism bo'yicha qidirish..." oninput="searchUsers(this.value)">
    </div>
    <div class="user-list" id="userList">
      <p style="text-align:center;padding:30px;color:#777;">Qidiruv orqali odam toping</p>
    </div>
  </div>

  <!-- 4. Chat oynasi -->
  <div id="chatStep" class="hidden chat-view">
    <div class="chat-header">
      <span class="back" onclick="backToUsers()">‚Üê</span>
      <img id="chatAvatar" src="">
      <div class="info">
        <div class="name" id="chatName"></div>
        <div class="status" id="chatStatus">offline</div>
      </div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="input-bar">
      <input type="file" id="imgInput" accept="image/*" style="display:none" onchange="sendImage(event)">
      <button onclick="document.getElementById('imgInput').click()" style="background:none;font-size:24px;">üìé</button>
      <input id="msgInput" placeholder="Xabar yozing..." onkeypress="if(event.key==='Enter')sendMsg()">
      <button onclick="sendMsg()">‚û§</button>
    </div>
  </div>

</div>

<script>
  const supabase = window.supabase.createClient(
    'https://acyozmmvrtvevbssoghh.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjeW96bW12cnR2ZXZic3NvZ2hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODg4MzQsImV4cCI6MjA3OTQ2NDgzNH0.XGtuvV8iTmBd1m6AjZhvkWqg-2kE83Yh_6oqvY2kQ5A'
  );

  let me = null;  // User ma'lumotlari
  let currentChat = null;

  // Magic link
  async function sendMagicLink() {
    const email = document.getElementById('email').value.trim();
    if (!email) return status('Email kiriting', 'error');
    const { error } = await supabase.auth.signInWithOtp({ 
      email,
      options: { emailRedirectTo: window.location.origin }
    });
    if (error) return status(error.message, 'error');
    status('Havola yuborildi! Pochtangizni tekshiring');
  }

  // Avatar preview
  function previewAvatar(e) {
    const file = e.target.files[0];
    if (file) {
      document.getElementById('profilePreview').src = URL.createObjectURL(file);
    }
  }

  // Profil saqlash (rasm yuklash bilan)
  async function saveProfile() {
    const username = document.getElementById('username').value.trim();
    if (!username) return showProfileError('Ism kiriting');
    if (!me) return showProfileError('Avval login qiling!');

    let avatar_url = null;
    const file = document.getElementById('avatarInput').files[0];
    if (file) {
      // Fayl nomini to'g'ri formatda: user_id/fayl_nomi
      const fileExt = file.name.split('.').pop();
      const fileName = `${me.id}.${fileExt}`;
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('avatars')
        .upload(`${me.id}/${fileName}`, file, { upsert: true });  // upsert: agar bor bo'lsa almashtir

      if (uploadError) {
        console.error('Upload xatosi:', uploadError);
        return showProfileError(`Rasm yuklanmadi: ${uploadError.message}`);
      }

      // Public URL olish
      const { data: urlData } = supabase.storage
        .from('avatars')
        .getPublicUrl(`${me.id}/${fileName}`);
      avatar_url = urlData.publicUrl;
    }

    // Profilni yangilash
    const { error: profileError } = await supabase.from('profiles').upsert({
      id: me.id,
      username,
      email: me.user.email,
      avatar_url,
      last_seen: new Date().toISOString()
    });

    if (profileError && profileError.code === '23505') return showProfileError('Bu ism band!');
    if (profileError) return showProfileError(profileError.message);

    // Sahifani qayta yuklash
    location.reload();
  }

  function showProfileError(msg) {
    const el = document.getElementById('profileError');
    el.textContent = msg;
    el.style.display = 'block';
  }

  // Online status yangilash
  async function updateOnline() {
    if (me) {
      await supabase.from('profiles').update({ last_seen: new Date().toISOString() }).eq('id', me.id);
    }
  }
  setInterval(updateOnline, 30000);
  window.addEventListener('beforeunload', updateOnline);

  // Notification ruxsati
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }

  // Auto login va user yuklash
  supabase.auth.getSession().then(async ({ data: { session } }) => {
    if (!session) return;
    me = session.user;  // Bu yerda me yuklanadi

    const { data: profileData } = await supabase.from('profiles').select('*').eq('id', me.id).single();
    if (!profileData || !profileData.username) {
      document.getElementById('authStep').classList.add('hidden');
      document.getElementById('profileStep').classList.remove('hidden');
    } else {
      document.getElementById('authStep').classList.add('hidden');
      document.getElementById('usersStep').classList.remove('hidden');
      updateOnline();
    }
  });

  // Qidiruv (oldingi kabi)
  async function searchUsers(q) {
    const list = document.getElementById('userList');
    list.innerHTML = '';
    if (q.length < 2) {
      list.innerHTML = '<p style="text-align:center;padding:30px;color:#777;">Ism kiriting...</p>';
      return;
    }
    const { data } = await supabase
      .from('profiles')
      .select('username,avatar_url,last_seen')
      .ilike('username', `%${q}%`)
      .neq('id', me.id);

    if (data.length === 0) {
      list.innerHTML = '<p style="text-align:center;padding:30px;color:#777;">Hech kim topilmadi</p>';
      return;
    }

    data.forEach(u => {
      const div = document.createElement('div');
      div.className = 'user-item';
      div.innerHTML = `
        <img src="${u.avatar_url || `https://via.placeholder.com/50/507ea8/fff?text=${u.username[0]}`}">
        <div>
          <div class="name">${u.username}</div>
          <div class="last">${new Date(u.last_seen).toLocaleString('uz-UZ')}</div>
        </div>
      `;
      div.onclick = () => openChat(u.username, u.avatar_url || '');
      list.appendChild(div);
    });
  }

  // Chat ochish (oldingi kabi)
  function openChat(username, avatar) {
    currentChat = username;
    document.getElementById('usersStep').classList.add('hidden');
    document.getElementById('chatStep').classList.remove('hidden');
    document.getElementById('chatName').textContent = username;
    document.getElementById('chatAvatar').src = avatar || 'https://via.placeholder.com/40';
    document.getElementById('messages').innerHTML = '';
    loadMessages();
    updateChatStatus(username);
  }

  // Chat status (oldingi kabi)
  async function updateChatStatus(username) {
    const { data } = await supabase.from('profiles').select('last_seen').eq('username', username).single();
    if (!data) return;
    const diff = (Date.now() - new Date(data.last_seen)) / 60000;
    const el = document.getElementById('chatStatus');
    el.textContent = diff < 3 ? 'online' : 'oxirgi marta ' + new Date(data.last_seen).toLocaleTimeString('uz');
    el.style.color = diff < 3 ? '#4caf50' : '#999';
  }

  // Xabar jo'natish (tuzatildi: myUsername ni to'g'ri olish)
  async function sendMsg() {
    const input = document.getElementById('msgInput');
    const text = input.value.trim();
    if (!text || !currentChat || !me) return;
    const myUsername = (await supabase.from('profiles').select('username').eq('id', me.id).single()).data.username;
    const chatId = [myUsername, currentChat].sort().join('_');
    const { error } = await supabase.from('messages').insert({ 
      chat_id: chatId, 
      sender: myUsername, 
      text 
    });
    if (error) console.error('Xabar xatosi:', error);
    input.value = '';
  }

  // Rasm jo'natish (chatda, tuzatildi)
  async function sendImage(e) {
    const file = e.target.files[0];
    if (!file || !currentChat || !me) return;
    const fileExt = file.name.split('.').pop();
    const fileName = `${Date.now()}.${fileExt}`;
    const { data: uploadData, error: uploadError } = await supabase.storage
      .from('chat_images')
      .upload(`${me.id}/${fileName}`, file, { upsert: true });

    if (uploadError) {
      console.error('Chat rasm xatosi:', uploadError);
      return alert(`Rasm yuklanmadi: ${uploadError.message}`);
    }

    const { data: urlData } = supabase.storage
      .from('chat_images')
      .getPublicUrl(`${me.id}/${fileName}`);
    const myUsername = (await supabase.from('profiles').select('username').eq('id', me.id).single()).data.username;
    const chatId = [myUsername, currentChat].sort().join('_');
    await supabase.from('messages').insert({
      chat_id: chatId,
      sender: myUsername,
      text: `<img src="${urlData.publicUrl}" style="max-width:100%;border-radius:12px;margin:5px 0;">`
    });
  }

  // Xabarlarni yuklash + real-time (oldingi kabi, lekin myUsername tuzatildi)
  async function loadMessages() {
    if (!me || !currentChat) return;
    const myUsername = (await supabase.from('profiles').select('username').eq('id', me.id).single()).data.username;
    const chatId = [myUsername, currentChat].sort().join('_');

    // Eski xabarlar
    const { data } = await supabase.from('messages').select().eq('chat_id', chatId).order('created_at');
    data.forEach(m => addMessage(m, myUsername));

    // Real-time
    supabase.channel('messages')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${chatId}` }, p => {
        addMessage(p.new, myUsername);
        if (p.new.sender !== myUsername && Notification.permission === 'granted') {
          new Notification('Yangi xabar', { body: `${p.new.sender}: ${p.new.text.replace(/<[^>]*>/g, '')}` });
        }
      })
      .subscribe();
  }

  function addMessage(m, myName) {
    const isMe = m.sender === myName;
    const div = document.createElement('div');
    div.className = `msg ${isMe ? 'sent' : 'received'}`;
    div.innerHTML = m.text + `<div class="msg-time">${new Date(m.created_at).toLocaleTimeString('uz', {hour:'2-digit', minute:'2-digit'})}</div>`;
    document.getElementById('messages').appendChild(div);
    div.scrollIntoView({ behavior: 'smooth' });
  }

  function backToUsers() {
    document.getElementById('chatStep').classList.add('hidden');
    document.getElementById('usersStep').classList.remove('hidden');
    currentChat = null;
  }

  function status(text, type = '') {
    const el = document.getElementById('status');
    el.textContent = text;
    el.style.color = type === 'error' ? 'red' : 'green';
  }
</script>
</body>
</html>

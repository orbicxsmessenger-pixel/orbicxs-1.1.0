<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OrbicXs</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;font-family:'SF Pro Display',sans-serif;}
    body{background:#000;display:flex;justify-content:center;align-items:center;height:100vh;overflow:hidden;}
    .app{width:100%;max-width:400px;height:100vh;background:#fff;overflow:hidden;display:flex;flex-direction:column;position:relative;box-shadow:0 10px 40px rgba(0,0,0,.4);border-radius:20px;}
    .screen{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;transition:all .4s ease;}
    .screen.hidden{transform:translateX(120%);opacity:0;pointer-events:none;}
    .logo svg{width:90px;height:90px;fill:#007aff;margin-bottom:40px;}
    .title{font-size:30px;font-weight:700;margin-bottom:30px;text-align:center;}
    .input{width:100%;padding:18px;border:1px solid #d0d0d0;border-radius:14px;font-size:18px;outline:none;background:#f9f9f9;}
    .btn{width:100%;padding:18px;background:#007aff;color:white;border:none;border-radius:14px;font-size:18px;font-weight:600;margin-top:30px;cursor:pointer;}
    #profileScreen .avatar{width:110px;height:110px;background:#e5e5ea;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:30px 0;}
    #profileScreen .avatar svg{width:70px;height:70px;fill:#888;}
    #chatsScreen{background:#f7f7f8;}
    .header{background:#fff;padding:16px;font-size:22px;font-weight:700;text-align:center;border-bottom:1px solid #e0e0e0;}
    .search{margin:12px 16px;}
    .search input{width:100%;padding:14px 18px;border-radius:12px;background:#e5e5e5;font-size:17px;outline:none;border:none;}
    .chat-list{flex:1;overflow-y:auto;}
    .chat-item{padding:14px 16px;display:flex;align-items:center;border-bottom:1px solid #eee;cursor:pointer;}
    .chat-item img{width:56px;height:56px;border-radius:50%;margin-right:16px;}
    .chat-item .name{font-weight:600;font-size:17.5px;}
    .chat-item .preview{color:#666;font-size:15px;margin-top:3px;}
    .chat-item .time{font-size:13px;color:#999;position:absolute;right:16px;top:16px;}
  </style>
</head>
<body>
  <div class="app">

    <!-- EMAIL -->
    <div id="emailScreen" class="screen">
      <div class="logo">
        <svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="#007aff"/><path d="M30 50a20 20 0 1 1 40 0" fill="none" stroke="#fff" stroke-width="8"/><circle cx="65" cy="45" r="8" fill="#fff"/></svg>
      </div>
      <div class="title">Enter your email</div>
      <input type="email" id="email" placeholder="name@email.com" class="input" />
      <button class="btn" onclick="sendMagicLink()">Continue</button>
    </div>

    <!-- PROFILE -->
    <div id="profileScreen" class="screen hidden">
      <div class="logo">
        <svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="#007aff"/><path d="M30 50a20 20 0 1 1 40 0" fill="none" stroke="#fff" stroke-width="8"/><circle cx="65" cy="45" r="8" fill="#fff"/></svg>
      </div>
      <div class="title">Profile info</div>
      <div class="avatar">
        <svg viewBox="0 0 100 100"><circle cx="50" cy="35" r="20" fill="#888"/><path d="M20 90c0-20 20-40 60-40s60 20 60 40" fill="none" stroke="#888" stroke-width="12"/></svg>
      </div>
      <input type="text" id="firstName" placeholder="First name" class="input" />
      <button class="btn" onclick="saveProfile()">Continue</button>
    </div>

    <!-- CHAT ROʻYXATI -->
    <div id="chatsScreen" class="screen hidden">
      <div class="header">OrbicXs</div>
      <div class="search"><input type="text" placeholder="Search" oninput="searchChats(this.value)" /></div>
      <div class="chat-list" id="chatList"></div>
    </div>

  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://acyozmmvrtvevbssoghh.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjeW96bW12cnR2ZXZic3NvZ2hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODg4MzQsImV4cCI6MjA3OTQ2NDgzNH0.XGtuvV8iTmBd1m6AjZhvkWqg-2kE83Yh_6oqvY2kQ5A'
    );

    let user = null;
    let myUsername = '';

    window.sendMagicLink = async () => {
      const email = document.getElementById('email').value.trim();
      if (!email) return alert("Email kiriting!");

      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: 'https://orbicxs-1-1-0.vercel.app/'   // TOʻGʻRI LINK!
        }
      });

      if (error) {
        alert("Xato: " + error.message);
      } else {
        alert("Havola yuborildi! Emailni tekshiring va bosing");
      }
    };

    window.saveProfile = async () => {
      const name = document.getElementById('firstName').value.trim();
      if (!name) return alert("Ism kiriting!");
      myUsername = '@' + name.toLowerCase().replace(/[^a-z0-9_]/g, '').substring(0,20);
      await supabase.from('profiles').upsert({ id: user.id, username: myUsername });
      show('chatsScreen');
    };

    function show(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
      document.getElementById(screenId).classList.remove('hidden');
    }

    // ENG MUHIM QISM – HAVOLA BOSILGANDA AVTO KIRISH!
    supabase.auth.onAuthStateChange(async (event, session) => {
      if (event === 'SIGNED_IN' && session?.user) {
        user = session.user;
        const { data } = await supabase.from('profiles').select('username').eq('id', user.id).single().catch(() => ({data:null}));
        if (data?.username) {
          myUsername = data.username;
          show('chatsScreen');
        } else {
          show('profileScreen');
        }
      }
    });

    // SAHIFA OCHILGANDA TEKSHIRISH
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user) {
        user = session.user;
        const { data } = await supabase.from('profiles').select('username').eq('id', user.id).single().catch(() => ({data:null}));
        if (data?.username) {
          myUsername = data.username;
          show('chatsScreen');
        } else {
          show('profileScreen');
        }
      }
    })();
  </script>
</body>
</html>
